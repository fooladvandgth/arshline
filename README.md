# Ø§ÙØ²ÙˆÙ†Ù‡ Ø¹Ø±Ø´Ù„Ø§ÛŒÙ† (ARSHLINE) v7.2.2 ğŸš€

**ÙØ±Ù…â€ŒØ³Ø§Ø² Ù¾ÛŒØ´Ø±ÙØªÙ‡ ÙØ§Ø±Ø³ÛŒ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆØ±Ø¯Ù¾Ø±Ø³**

Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªÙ…Ø§Ù…â€ŒØµÙØ­Ù‡ØŒ ÙØ±Ù…â€ŒØ³Ø§Ø² Ù…Ø¯Ø±Ù† RTLØŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù‡ÙˆØ´ÛŒØ§Ø±ØŒ Ùˆ API Ù†Ø³Ø®Ù‡â€ŒØ¯Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª ÙØ±Ù…â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡ ØªØ§ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø± ÙˆØ±Ø¯Ù¾Ø±Ø³.

[![Ù†Ø³Ø®Ù‡](https://img.shields.io/badge/version-7.2.2-blue.svg)](https://github.com/fooladvandgth/arshline)
[![Ù„Ø§ÛŒØ³Ù†Ø³](https://img.shields.io/badge/license-GPL2-green.svg)](LICENSE)
[![ÙˆØ±Ø¯Ù¾Ø±Ø³](https://img.shields.io/badge/wordpress-6.0%2B-blue.svg)](https://wordpress.org)
[![PHP](https://img.shields.io/badge/php-8.1%2B-purple.svg)](https://php.net)

## Ø§Ù…Ú©Ø§Ù†Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ
- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø§ Ø·Ø±Ø§Ø­ÛŒ Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ (Glass) Ùˆ ØªÙ… Ø±ÙˆØ´Ù†/ØªØ§Ø±ÛŒÚ©
- ÙØ±Ù…â€ŒØ³Ø§Ø² Ù…Ø³ØªÙ‚Ù„ Ø¨Ø§ Ú†ÛŒØ¯Ù…Ø§Ù† Â«ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú†Ù¾ / Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø±Ø§Ø³ØªÂ»
- ÙÛŒÙ„Ø¯ Â«Ù¾Ø§Ø³Ø® Ú©ÙˆØªØ§Ù‡Â» Ø¨Ø§ ÙØ±Ù…Øªâ€ŒÙ‡Ø§: free_text, email, numeric, date_jalali, date_greg, time, mobile_ir, mobile_intl, tel, fa_letters, en_letters, ip, national_id_ir, postal_code_ir
- Placeholder Ù‡ÙˆØ´Ù…Ù†Ø¯Ø› Ù¾ÛŒØ´â€ŒÙØ±Ø¶ free_text: Â«Ù¾Ø§Ø³Ø® Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯Â»
- Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ + Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ (Toggle)
- ØªØ§Ú¯Ù„ Â«ØªÙˆØ¶ÛŒØ­Ø§ØªÂ» Ø¨Ø§ Ø§Ø³ØªØ§ÛŒÙ„ VC Switch (Yes/No)
- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù…â€ŒØµÙØ­Ù‡ Ø¨Ø§ Ù…Ø§Ø³Ú© ÙˆØ±ÙˆØ¯ÛŒ Ùˆ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
- REST API Ù†Ø³Ø®Ù‡â€ŒØ¯Ø§Ø±: CRUD ÙØ±Ù…â€ŒÙ‡Ø§ØŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§
	- Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø«Ø§Ø¨Øª: Â«Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Â» (Ø§Ø¨ØªØ¯Ø§) Ùˆ Â«Ù¾ÛŒØ§Ù… ØªØ´Ú©Ø±Â» (Ø§Ù†ØªÙ‡Ø§) + Ø§Ù…Ú©Ø§Ù† Ø­Ø°Ù
	- Ø§Ø¯ÛŒØªÙˆØ± Ù¾ÛŒØ§Ù…: Ø¹Ù†ÙˆØ§Ù†/Ù…ØªÙ†/ØªØµÙˆÛŒØ± + Ø¢Ù¾Ù„ÙˆØ¯ Ø§Ø² Ø¯Ø§Ø®Ù„ Ø§Ø¯ÛŒØªÙˆØ±
	- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Â«Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´Â» Ø¯Ø± Ø¨ÛŒÙ„Ø¯Ø± Ùˆ Ø§Ø¯ÛŒØªÙˆØ±
	- Ø­Ø°Ù ØªÚ©ÛŒ Ø³Ø¤Ø§Ù„ + Ø§Ù†ØªØ®Ø§Ø¨ Ú†Ù†Ø¯ØªØ§ÛŒÛŒ Ùˆ Ø­Ø°Ù Ú¯Ø±ÙˆÙ‡ÛŒ Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†Ø±Ù…
	- Ø¯Ø±Ú¯â€ŒØ§Ù†Ø¯Ø§Ù¾ Ù¾Ø§ÛŒØ¯Ø§Ø± (SortableJSØŒ Placeholder Ù…Ù„Ø§ÛŒÙ…ØŒ ØªÙ…ÛŒØ²Ú©Ø§Ø±ÛŒ Ú¯ÙˆØ³Øª/Placeholder)
	- Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Hash (Back Ù…Ø±ÙˆØ±Ú¯Ø±) Ùˆ Ù‡Ø´Ø¯Ø§Ø± Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø§Ø¯ÛŒØªÙˆØ±
	- Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ Ø¢ÛŒÚ©ÙˆÙ†ÛŒ Ø¨Ø§ Ø¬Ù…Ø¹/Ø¨Ø§Ø²Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ø¨ÛŒÙ„Ø¯Ø±/Ø§Ø¯ÛŒØªÙˆØ±/Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´

## Ø´Ø±ÙˆØ¹ Ø³Ø±ÛŒØ¹
1. Ù†ØµØ¨ Ø¯Ø± Ù…Ø³ÛŒØ± `wp-content/plugins/arshline`
2. ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§ÙØ²ÙˆÙ†Ù‡ Ø§Ø² Ù¾ÛŒØ´Ø®ÙˆØ§Ù† ÙˆØ±Ø¯Ù¾Ø±Ø³
3. Ø§Ø² Ù…Ù†ÙˆÛŒ Â«Ø¹Ø±Ø´Ù„Ø§ÛŒÙ†Â» ÙˆØ§Ø±Ø¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø®ØªØµØ§ØµÛŒ Ø´ÙˆÛŒØ¯
4. Ø¯Ø± ØªØ¨ Â«ÙØ±Ù…â€ŒÙ‡Ø§Â»ØŒ ÙØ±Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²ÛŒØ¯ ÛŒØ§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯

## ØªÙˆØ³Ø¹Ù‡
- PHP 8.1+ØŒ ÙˆØ±Ø¯Ù¾Ø±Ø³ 6.x
- Ø³Ø§Ø®ØªØ§Ø± Ù…Ø§Ú˜ÙˆÙ„Ø§Ø± Ø¯Ø± `src/`
- ØªÙ…â€ŒÙ‡Ø§ Ùˆ UI Ø¯Ø± `src/Dashboard`
- ØªØ³Øªâ€ŒÙ‡Ø§ Ø¯Ø± `tests/`

## ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø®ÛŒØ±
Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø± ÙØ¹Ù„ÛŒ: 1.4.1 (2025-09-23)

Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¯Ø± `CHANGELOG_DASHBOARD.md` Ùˆ Ù¾ÛŒØ´Ø±ÙØªâ€ŒÙ‡Ø§ Ø¯Ø± `PROGRESS_LOG.md` Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.

### Backend Event Streaming (Logging Integration)

### Ú©Ù†ØªØ±Ù„ ØªÙ… Ø¨Ø§ Ù‡ÙˆØ´ÛŒØ§Ø± (AI Theme Control)
Ø§Ø² Ø·Ø±ÛŒÙ‚ ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ù‡ÙˆØ´ÛŒØ§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÙ… Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯:

Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø³ØªÙˆØ±Ø§Øª:
```
Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ© Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†
Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†
ØªÙ… Ø±Ø§ Ø¹ÙˆØ¶ Ú©Ù†
Ø¨Ø±Ùˆ Ø±ÙˆÛŒ Ø­Ø§Ù„Øª Ø´Ø¨
Ø¨Ø±Ú¯Ø±Ø¯ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø±ÙˆØ²
ØªÙ… ØªØ§Ø±ÛŒÚ©
ØªÙ… Ø±ÙˆØ´Ù†
ØªØ§Ø±ÛŒÚ© Ú©Ù†
Ø±ÙˆØ´Ù† Ú©Ù†
```
ØªÙˆØ¶ÛŒØ­:
- Â«Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ© Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†Â» â†’ Ø§Ø±Ø³Ø§Ù„ intent Ø¨Ø§ `mode=dark`
- Â«Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†Â» â†’ Ø§Ø±Ø³Ø§Ù„ intent Ø¨Ø§ `mode=light`
- Â«ØªÙ… Ø±Ø§ Ø¹ÙˆØ¶ Ú©Ù†Â» â†’ ÙÙ‚Ø· toggle (ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ)

Ù¾ÛŒØ§Ù… ØªØ£ÛŒÛŒØ¯ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹: Â«Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ© ÙØ¹Ø§Ù„ Ø´Ø¯.Â»).


The `hoosha/prepare` endpoint now returns an `events` array in addition to `progress` and `notes`:

```
events: [
	{ seq: 0, type: 'progress', step: 'model_request', message: 'Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ù…Ø¯Ù„' },
	{ seq: 1, type: 'note', note: 'pipe:chunk_progress(1/3)' },
	{ seq: 2, type: 'note', note: 'perf:total_ms=1234' }
]
```

Frontend (`dashboard-controller.js`) iterates these and emits console lines with prefix `[ARSH-EVENT]`, which are captured by `console-capture.js`. This provides granular visibility into pipeline stages (chunking, refine pass, final review, performance metrics).

If you build a custom UI, read `events` and stream them live for a real-time progress console.

### Field Coverage & Soft Prune

To mitigate over-aggressive reduction on large heterogeneous inputs, the prepare pipeline now includes:

- Dynamic coverage threshold (`coverage_threshold` request body param, default 0.55). If final model+heuristic field count / baseline field count < threshold, missing baseline fields are injected with `props.source=coverage_injected`.
- Optional second refine pass for only injected fields via `coverage_refine=true` which may relabel / infer formats; refined ones tagged `coverage_injected_refined`.
- Fallback file injection: if no `type=file` fields remain but text clearly references files (PDF, ØªØµÙˆÛŒØ±, log, MP4), synthetic file fields are appended with `source=file_injected` and reasonable accept/multiple props.
- Soft prune mode: duplicates are no longer removed, only tagged with `duplicate_of` and notes include `heur:prune_soft_mode` plus `heur:duplicates_found(N)`.

Progress steps that may appear:
 - `coverage_enforced`
 - `coverage_refine`
 - `file_injected`

Notes emitted:
 - `heur:coverage_injected(N)`
 - `pipe:coverage_refine_start(N)` / `pipe:coverage_refine_applied(M)`
 - `heur:file_fallback_injected(N)`
 - `heur:prune_soft_mode`
 - `heur:duplicates_tagged(N)`

### Canonical Label Dedupe
Numbering (Persian/Arabic/Latin digits + punctuation) is stripped when deciding if a baseline field already exists, preventing duplicate re-injection like "Û±. Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" vs "Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ".

### Stricter File Injection
File fallback only triggers if explicit keywords (ÙØ§ÛŒÙ„|Ø±Ø²ÙˆÙ…Ù‡|Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ|Ø¢Ù¾Ù„ÙˆØ¯|ØªØµÙˆÛŒØ±|Ø±Ø³ÛŒØ¯|jpg|jpeg|png|Ú¯Ø²Ø§Ø±Ø´|log|ÙˆÛŒØ¯ÛŒÙˆ|mp4) are present; otherwise a skip note is added: `heur:file_injection_skipped(no_keyword)` or `heur:file_injection_skipped(no_pattern_match_detail)`.

These help auditors understand why overall field count increased post-model.

### Preserve Order & Summary Metrics
If you pass `{"preserve_order": true}` in the `hoosha/prepare` POST body, the final `schema.fields` list is re-sorted to follow the original baseline heuristic extraction order (after canonical label normalization). Fields not present in the baseline (pure model additions, injected coverage or file fields) are appended afterward.

The response now contains a `summary` object for fast auditing:

```
summary: {
	baseline_count: <int>,        // number of baseline heuristic fields
	final_count: <int>,           // number of fields returned in final schema
	coverage_ratio: <number|null>,// final_count / baseline_count (3 decimals) or null if baseline_count=0
	sources: {                    // counts per field source tag
		model: <int>,
		heuristic_or_unchanged: <int>,
		reconciled_from_baseline: <int>,
		coverage_injected: <int>,
		coverage_injected_refined: <int>,
		file_injected: <int>
	},
	preserve_order: <bool>
}
```

### Duplicate (DUP) Badge
Soft prune mode retains duplicates and marks them with `props.duplicate_of` referencing the zero-based index of the original field. The dashboard preview now displays a red `DUP` badge with a tooltip like: Â«Duplicate of original field #3Â». This enables reviewers to quickly see that the field was detected as a semantic duplicate without being removed.

### ÙØ±Ù… Ù†ÛŒÙ… (form_name) Ø®ÙˆØ¯Ú©Ø§Ø±
Ø¯Ø± ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ `POST /hoosha/prepare` Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙÛŒÙ„Ø¯ Ø§Ø®ØªÛŒØ§Ø±ÛŒ `form_name` Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:

```
{ "user_text": "...", "form_name": "ÙØ±Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡" }

### Hoshiyar: Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù…Ù†Ùˆ (Menu Navigation)
Hoshiyar Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§ ÙØ±Ù…Ø§Ù† Ù…ØªÙ†ÛŒ ÛŒØ§ ØµÙˆØªÛŒ ØµÙØ­Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ø§ÙØ²ÙˆÙ†Ù‡ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†Ø¯.

Ø¯Ùˆ Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª Ø¬Ø¯ÛŒØ¯:

`GET /wp-json/arshline/v1/menus`
Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯:
```
{
	"menus": [
		{ "slug": "arshline-dashboard", "page_title": "Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¹Ø±Ø´Ù„Ø§ÛŒÙ†", "commands": ["Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯", "arshline dashboard", ...] },
		{ "slug": "arshline-user-groups", "page_title": "Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¹Ø±Ø´Ù„Ø§ÛŒÙ†", "commands": ["Ú¯Ø±ÙˆÙ‡ Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ", "user groups", ...] }
	]
}
```

`GET /wp-json/arshline/v1/menus/resolve?q=<query>`
Ù†Ù…ÙˆÙ†Ù‡:
```
GET .../menus/resolve?q=Ø¨Ø§Ø²%20Ú©Ø±Ø¯Ù†%20Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
=> { "found": true, "menu": { "slug": "arshline-dashboard", ... } }
```

Ù†Ù…ÙˆÙ†Ù‡ ÙØ±Ù…Ø§Ù†â€ŒÙ‡Ø§ (FA):
- Â«Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯Â»
- Â«Ú¯Ø±ÙˆÙ‡ Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±ÛŒÂ»
- Â«Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±ÙˆÙ‡ Ù‡Ø§Â»

Ù†Ù…ÙˆÙ†Ù‡ ÙØ±Ù…Ø§Ù†â€ŒÙ‡Ø§ (EN):
- "open dashboard"
- "user groups"
- "manage groups"

ÙØ±Ø§Ù†Øªâ€ŒØ§Ù†Ø¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù¾Ø³ Ø§Ø² resolveØŒ Ø¨Ø§ Ø³Ø§Ø®Øª URL `admin.php?page=<slug>` Ù‡Ù…Ø§Ù† ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†Ø¯.

```

Ø§Ú¯Ø± `form_name` Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÛŒÚ© Ù†Ø§Ù… Ú©ÙˆØªØ§Ù‡ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯:
1. ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø±Ú†Ø³Ø¨ (Label) ÙÛŒÙ„Ø¯ Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒØ´Ø¯Ù‡ Ù¾Ø§ÛŒÙ‡
2. Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Û² ØªØ§ Ûµ ÙˆØ§Ú˜Ù‡ Ù…Ø¹Ù†Ø§Ø¯Ø§Ø± Ù†Ø®Ø³Øª Ù…ØªÙ† (Ø­Ø°Ù Ú©Ù„Ù…Ø§Øª ØªÙˆÙ‚Ù Ù…Ø§Ù†Ù†Ø¯ Â«Ø§Ø²ØŒ Ø¨Ù‡ØŒ ÙˆØŒ Ø¯Ø±ØŒ Ø¨Ø±Ø§ÛŒ ...Â»)
3. Ú©ÙˆØªØ§Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ§ Û¶Û° Ú©Ø§Ø±Ø§Ú©ØªØ±
4. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù¾Ø³ Ø§Ø² Ù†Ù‡Ø§ÛŒÛŒ Ø´Ø¯Ù† Ø§Ø³Ú©ÛŒÙ…Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ ÛŒÚ© ØªÙ„Ø§Ø´ Ø«Ø§Ù†ÙˆÛŒÙ‡ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† ÙÛŒÙ„Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯

Ù†ÙˆØªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆÙ†Ø¯:
- `heur:form_name_provided` Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù… Ø±Ø§ Ø®ÙˆØ¯Ø´ Ø¯Ø§Ø¯Ù‡
- `heur:form_name_heuristic` Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ Ù†Ø§Ù… Ø¨Ø§ Ø±ÙˆØ´ ÙˆØ§Ú˜Ú¯Ø§Ù† Ù…Ø¹Ù†Ø§Ø¯Ø§Ø± ÛŒØ§ Ø¨Ø±Ú†Ø³Ø¨ Ø§ÙˆÙ„ÛŒÙ‡ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡
- `heur:form_name_from_schema` ÙˆÙ‚ØªÛŒ Ù¾Ø³ Ø§Ø² Ù†Ù‡Ø§ÛŒÛŒ Ø´Ø¯Ù† Ø§Ø³Ú©ÛŒÙ…Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø§Ø³Øª

Ø®Ø±ÙˆØ¬ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø´Ø§Ù…Ù„ Ú©Ù„ÛŒØ¯ `form_name` Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.

### ÙˆÛŒØ±Ø§ÛŒØ´ Ø·Ø¨ÛŒØ¹ÛŒ (Natural Language Editing)
ÛŒÚ© Ø¨Ø§Ú©Ø³ Â«Ù…ØªÙ† Ø·Ø¨ÛŒØ¹ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´Â» Ø²ÛŒØ± Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¨Ù‡ Ø²Ø¨Ø§Ù† Ø¹Ø§Ù…ÛŒØ§Ù†Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:

Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§:
```
Ø³ÙˆØ§Ù„ Ø§ÙˆÙ„ Ø±Ùˆ Ø±Ø³Ù…ÛŒ Ú©Ù† Ùˆ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø¨Ø´Ù‡
Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„ Ø´ØºÙ„ Ø³Ù‡ ØªØ§ Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†: Ú©Ø§Ø±Ù…Ù†Ø¯ØŒ Ø¢Ø²Ø§Ø¯ØŒ ÙØ±ÛŒÙ„Ù†Ø³
Ø³ÙˆØ§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ø±Ùˆ Ø¨ÛŒØ§Ø± Ø¨Ø§Ù„Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„
Ú¯Ø²ÛŒÙ†Ù‡ Ù‡Ø§ÛŒ Ø³ÙˆØ§Ù„ Ø¬Ù†Ø³ÛŒØª Ø±Ùˆ ÙÙ‚Ø· Ø²Ù† Ùˆ Ù…Ø±Ø¯ Ú©Ù†
Ø³ÙˆØ§Ù„ Ø³ÙˆÙ… Ø±Ùˆ Ø­Ø°Ù Ú©Ù†
```

Ø¯Ú©Ù…Ù‡ Â«ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù‡ Ø¯Ø³ØªÙˆØ±Ø§ØªÂ» Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Endpoint Ø¬Ø¯ÛŒØ¯ `/hoosha/interpret_nl` Ù…ÛŒâ€ŒÙØ±Ø³ØªØ¯. Ù¾Ø§Ø³Ø® Ø´Ø§Ù…Ù„ Ø¢Ø±Ø§ÛŒÙ‡ `commands` Ø§Ø³Øª Ú©Ù‡ Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± ÙÛŒÙ„Ø¯ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ Ùˆ Ø¹Ù…Ù„ÛŒØ§Øª Apply Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

### Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ùˆ ØªØ§ÛŒÛŒØ¯ ØªØºÛŒÛŒØ±Ø§Øª (preview_edit)
Ø¬Ø±ÛŒØ§Ù† Ø¬Ø¯ÛŒØ¯ Ø§Ù…Ù†â€ŒØªØ±:
1. Ù…ØªÙ† Ø·Ø¨ÛŒØ¹ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¯Ø± Ø¨Ø§Ú©Ø³ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.
2. Ø¯Ú©Ù…Ù‡ Â«Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØºÛŒÛŒØ±Ø§ØªÂ» â†’ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ `POST /hoosha/preview_edit` Ø¨Ø§ Ø¨Ø¯Ù†Ù‡:
```
{ "schema": { ... }, "natural_prompt": "..." }
```
3. Ø³Ø±ÙˆØ±: ØªÙØ³ÛŒØ± (`interpret_nl`) â†’ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ `commands` â†’ Ø§Ø¹Ù…Ø§Ù„ Ù…ÙˆÙ‚ØªÛŒ ØªÙˆØ³Ø· Ù…Ø¯Ù„ â†’ ØªÙˆÙ„ÛŒØ¯ `preview_schema` + `deltas`.
4. ÙØ±Ø§Ù†Øªâ€ŒØ§Ù†Ø¯ Ø§Ø®ØªÙ„Ø§Ùâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡ (Labels/Types/Count) Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
5. Ø¯Ú©Ù…Ù‡ Â«ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø¹Ù…Ø§Ù„Â» â†’ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø§Ø³Ú©ÛŒÙ…Ø§ÛŒ Ø¬Ø§Ø±ÛŒ Ø¨Ø§ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´Ø› Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯ÙˆÙ… Ø¨Ù‡ Ù…Ø¯Ù„.
6. Â«Ø§Ù†ØµØ±Ø§ÙÂ» â†’ Ø±Ø¯ ØªØºÛŒÛŒØ±Ø§Øª.

### Root-Cause AI Refinement & Guard Redesign (Constraint-Based)

Examples are symptomatic only, not the targets of the fix. This release introduces a systemic redesign of the refinement + guard pipeline focused on eliminating root causes of hallucinated fields, semantic duplication, and weak type inference.

Key Principles:
- Constraint-driven generation: output_count == input_count (no silent additions).
- Semantic clustering (Persian-aware) using token normalization + similarity.
- Guard shifts from reporter to corrective: merges semantic duplicates, enforces types, prunes unauthorized additions.
- Deterministic type/format inference (age â†’ number, national id â†’ national_id_ir, date of birth â†’ date_greg, binary intent â†’ multiple_choice with Ø¨Ù„Ù‡/Ø®ÛŒØ±, phone â†’ mobile_ir).
- Notes now may include: `guard:semantic_cluster`, `guard:type_correct(...)`, `guard:duplicate_collapsed(N)`, `guard:ai_removed(M)`.

Added Components:
- `SemanticTools.php` (normalize_label, token_set, similarity, cluster_labels).
- Enhanced `GuardService::evaluate` with semantic clustering & generic heuristics (no hardcoded per-example patches).
- Constraint-based system prompt for refinement (one field per question, strict JSON, no hallucination).

Benchmark Harness:
- `tools/run_guard_bench.php` runs multiple generic scenarios (identity, redundancy, binary intent, format focus, noise) and emits NDJSON metrics (field fidelity, hallucination rate, duplicates collapsed, type/option corrections).

Success Criteria (Phase 1 Targets):
- Field Count Fidelity â‰¥ 0.99.
- Hallucination Rate = 0 on benchmark suite.
- Residual semantic duplicates = 0 (post-guard) for standard cases.
- Latency overhead < 15% vs prior implementation.

Extension Points:
- Extend stopword list & similarity threshold in `SemanticTools` for domain tuning.
- Add new format heuristics by appending rules in Guard type enforcement block.
- Introduce embedding-based semantic matching later without refactoring current API.

Reject any optimization that only fits the examplesâ€”solution must generalize to unseen input patterns beyond those shown in logs.

### ØªÙ†Ø¸ÛŒÙ… Ø¢Ø³ØªØ§Ù†Ù‡ Ø´Ø¨Ø§Ù‡Øª Ù…Ø¹Ù†Ø§ÛŒÛŒ (Semantic Similarity Threshold)
ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ ØªÙ†Ø¸ÛŒÙ…ÛŒ Ø¬Ø¯ÛŒØ¯: `guard_semantic_similarity_min` (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 0.8ØŒ Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø¹ØªØ¨Ø± 0.5 ØªØ§ 0.95) Ú©Ù‡ Ø¯Ø± GuardService Ùˆ GuardUnit Ø¨Ø±Ø§ÛŒ:
- Ù„ÛŒÙ†Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Ø¨Ù‡ Ø³Ø¤Ø§Ù„ ÙˆØ±ÙˆØ¯ÛŒ (semantic_link)
- ØªØ´Ø®ÛŒØµ hallucination (Ø§Ú¯Ø± similarity < threshold)
Ù‚Ø§Ø¨Ù„ override Ø¯Ø± Ù…Ø­ÛŒØ· ØªØ³Øª Ø¨Ø§ Ù…ØªØ¯: `SemanticTools::setOverrideThreshold($val)`.

ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ú¯Ø²ÛŒÙ†Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (`arshline_settings`) ÛŒØ§ ÙÛŒÙ„ØªØ± WordPress Ø¢ÛŒÙ†Ø¯Ù‡ (Ø¯Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡). Ù…Ù‚Ø¯Ø§Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

### Semantic Merge Alignment (Ø§Ø¯ØºØ§Ù… Ù…Ø¹Ù†Ø§ÛŒÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ù¾Ø±Ú†Ù… AI-added)
Ù¾ÛŒØ´ Ø§Ø² Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ ÙÛŒÙ„Ø¯ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ø§Ø¶Ø§ÙÙ‡â€ŒÛŒ Ù…Ø¯Ù„ØŒ ÛŒÚ© ÙØ§Ø² Â«Ø§Ø¯ØºØ§Ù… Ù…Ø¹Ù†Ø§ÛŒÛŒÂ» Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù‡:
1. Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø±Ø§ normalize (Ø­Ø°Ù ÙØ§ØµÙ„Ù‡ ØªÚ©Ø±Ø§Ø±ÛŒØŒ Ø§Ø±Ù‚Ø§Ù…ØŒ Ù†Ø´Ø§Ù†Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒØŒ ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ‚Ù Ù…ÙˆØ¯Ø¨Ø§Ù†Ù‡)
2. Ø´Ø¨Ø§Ù‡Øª Ø¬Ø§Ú©Ø§Ø±Ø¯ ØªÙˆÚ©Ù†ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
3. Ø§Ú¯Ø± Ù…Ø´Ø§Ø¨Ù‡ ÙÛŒÙ„Ø¯ baseline Ø¨Ø§Ø´Ø¯ (>= threshold) Ø¢Ù† Ø±Ø§ merged Ùˆ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª: `guard:semantic_merge(label_out=...,origin=...,score=...)` Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.
Ø§ÛŒÙ† Ú©Ø§Ø± False Positive Ù‡Ø§ÛŒ hallucination Ø±Ø§ (Ø¨Ø±Ø§ÛŒ ØªÙØ§ÙˆØª Ø³Ø¨Ú©ÛŒ Ø¨Ø±Ú†Ø³Ø¨) Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯.

### Guard Unit Architecture (Ù†Ø³Ù„ Ø¬Ø¯ÛŒØ¯ Ù„Ø§ÛŒÙ‡ ØµØ­Øªâ€ŒØ³Ù†Ø¬ÛŒ)
Ù„Ø§ÛŒÙ‡ Ø¬Ø¯ÛŒØ¯ `GuardUnit` Ø¯Ø± Ú©Ù†Ø§Ø± `GuardService` Ø¨Ù‡ ØµÙˆØ±Øª Ù…ÙˆØ§Ø²ÛŒ (Ø­Ø§Ù„Øª diagnostic) Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ ØªØ¯Ø±ÛŒØ¬Ø§Ù‹ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´ÙˆØ¯.

Phases:
1. Meta Preflight: Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ `meta.input_count == meta.output_count` Ùˆ `added == 0`.
2. Normalization & Scaffold: Ø³Ø§Ø®Øª Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø®Ù„ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ (norm_label, working_type, props).
3. Semantic Matching: Ø¬ÙØªâ€ŒØ³Ø§Ø²ÛŒ Ù‡Ø± ÙÛŒÙ„Ø¯ Ø¨Ø§ Ø¨Ù‡ØªØ±ÛŒÙ† Ø³Ø¤Ø§Ù„ (similarity, matched_question).
4. Type/Format Correction (Ø¯Ø± Ø­Ø§Ù„Øª corrective): age â†’ numberØŒ ØªØ§Ø±ÛŒØ® â†’ date_gregØŒ Ú©Ø¯ Ù…Ù„ÛŒ â†’ national_id_irØŒ ØªÙ„ÙÙ† â†’ mobile_irØŒ yes/no intent â†’ multiple_choice.
5. Hallucination Detection: ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø¢Ø³ØªØ§Ù†Ù‡ Ø¯Ø± Ø­Ø§Ù„Øª corrective Ø­Ø°ÙØŒ Ø¯Ø± Ø­Ø§Ù„Øª diagnostic ÙÙ‚Ø· flag (`guard:would_prune`).
6. Count Enforcement: Ø§Ú¯Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ø§ØµÙ„Ø§Ø­ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§ ÙˆØ±ÙˆØ¯ÛŒ ÙØ±Ù‚ Ú©Ù†Ø¯ `guard:count_mismatch(...)`.
7. Metrics & Summary: Ø®Ø±ÙˆØ¬ÛŒ Ø´Ø§Ù…Ù„ similarity_avgØŒ hallucinations_removedØŒ type_corrections.

Mode Switch:
- Constant: `define('HOOSHA_GUARD_MODE','corrective');` ÛŒØ§ `diagnostic` (Ù¾ÛŒØ´â€ŒÙØ±Ø¶)
- Option: `guard_mode` Ø¯Ø± `arshline_settings`

### Dynamic Capability Scan
Ú©Ù„Ø§Ø³ `CapabilityScanner` Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø§Ù†ÙˆØ§Ø¹ØŒ ÙØ±Ù…Øªâ€ŒÙ‡Ø§ Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ø§Ø² ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‡Ø³ØªÙ‡ (`Api.php`, `FormValidator.php`, `form-template.php`, `GuardService.php`, `OpenAIModelClient.php`) Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÛŒâ€ŒÚ©Ù†Ø¯:
- Ø®Ø±ÙˆØ¬ÛŒ Ú©Ø´ Ø´Ø¯Ù‡ (in-process + transient Û± Ø³Ø§Ø¹ØªÙ‡)
- Ø«Ø¨Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ `phase=capability_scan` Ø¯Ø± `guard.log`
Ø§ÛŒÙ† Ù†Ù‚Ø´Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§ØµÙ„Ø§Ø­ Ù†ÙˆØ¹/ÙØ±Ù…Øª Ùˆ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

### Field-Level Logging (GuardLogger)
ÙØ§ÛŒÙ„: `guard.log` (Û±Û°MB rotation)
Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§:
```
{"ev":"phase","phase":"start","mode":"diagnostic"}
{"ev":"field","field_idx":2,"action":"semantic_link","question_idx":1,"score":0.87}
{"ev":"field","field_idx":3,"action":"flag_hallucination","score":0.41}
{"ev":"field","field_idx":3,"action":"prune","reason":"low_similarity"} (Ø¯Ø± Ø­Ø§Ù„Øª corrective)
{"ev":"summary","metrics":{...},"issues":[...],"notes":[...]}
```
ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ:
- Constant: `define('HOOSHA_GUARD_DEBUG', true);`
- Option: `guard_debug` Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª
Ù…Ø³ÛŒØ± Ø³ÙØ§Ø±Ø´ÛŒ: Ú¯Ø²ÛŒÙ†Ù‡ `arshline_guard_log_path`.

### Meta Enforcement (Early)
Ø¯Ø± `OpenAIModelClient::refine` Ù¾Ø³ Ø§Ø² parse JSON:
- Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø³Ø¤Ø§Ù„Ø§Øª Ú©Ø§Ø±Ø¨Ø± (`input_count`) Ø¨Ø§ ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆÛŒØ³Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø³Ø´ÛŒ Ùˆ Ø®Ø·ÙˆØ·
- Ø³Øª `meta.output_count` Ùˆ `meta.added`
- Ø¯Ø± ØµÙˆØ±Øª Ù…ØºØ§ÛŒØ±Øª: `meta.violation[]` Ø´Ø§Ù…Ù„ `count_mismatch` ÛŒØ§ `added_positive`
GuardUnit Ø³Ù¾Ø³ Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ø±Ø§ Ø¨Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ `guard:meta_violation` Ùˆ `guard:meta_added` Ø¨Ø§Ø²ØªØ§Ø¨ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.

### Type / Format Correction (GuardUnit Corrective Mode)
Ù‡Ù†Ú¯Ø§Ù… ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ø­Ø§Ù„Øª corrective:
- `Ø³Ù† / Ú†Ù†Ø¯ Ø³Ø§Ù„` â†’ `type=number`
- `ØªØ§Ø±ÛŒØ®` â†’ `format=date_greg` (Ø§Ú¯Ø± Jalali Ù…Ø´Ø®Øµ Ù†Ø¨Ø§Ø´Ø¯)
- `Ú©Ø¯ Ù…Ù„ÛŒ` â†’ `format=national_id_ir`
- `Ù…ÙˆØ¨Ø§ÛŒÙ„ / ØªÙ„ÙÙ†` â†’ `format=mobile_ir`
- Ø¬Ù…Ù„Ø§Øª yes/no (Ø´Ø±ÙˆØ¹ Ø¨Ø§ Â«Ø¢ÛŒØ§Â» ÛŒØ§ Ø³Ø§Ø®ØªØ§Ø± Ø¯ÙˆØ¯ÙˆÛŒÛŒ) â†’ multiple_choice + options ["Ø¨Ù„Ù‡","Ø®ÛŒØ±"]
Ù‡Ø± ØªØºÛŒÛŒØ±: `guard:type_correct_phase(field_idx=...:type=...|format=...)` + Ø±ÙˆÛŒØ¯Ø§Ø¯ log Ø¨Ø§ `action=type_format_correct`.

### Benchmark Summary Line (CI Friendly)
Ø§Ø³Ú©Ø±ÛŒÙ¾Øª `tools/run_guard_bench.php` Ø§Ú©Ù†ÙˆÙ† Ø®Ø· Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ú†Ø§Ù¾ Ù…ÛŒâ€ŒÚ©Ù†Ø¯:
```
BENCH_SUMMARY total_scenarios=5 fidelity_ok=1 avg_hallucination_rate=0
```
Ù¾Ø§Ø±Ø³Ø± CI Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§ regex Ø³Ø§Ø¯Ù‡ Ø¢Ù† Ø±Ø§ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ùˆ Ø±ÙˆÙ†Ø¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†Ø¯.

### Flags & Constants Quick Reference
| Constant | Ù†Ù‚Ø´ |
|----------|-----|
| HOOSHA_GUARD_DEBUG | ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯ Ù…ÛŒØ¯Ø§Ù† Ùˆ ÙØ§Ø² (guard.log) |
| HOOSHA_GUARD_MODE  | ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª GuardUnit Ø¨ÛŒÙ† diagnostic / corrective |
| ARSHLINE_HOOSHA_LOG_ENABLED | ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ù„ Ù„Ø§Ú¯ (hoosha.log) |

| Option (settings) | Ú©Ù„ÛŒØ¯ |
|-------------------|------|
| guard_semantic_similarity_min | Ø¢Ø³ØªØ§Ù†Ù‡ Ø´Ø¨Ø§Ù‡Øª (0.5â€“0.95) |
| guard_mode | Ø­Ø§Ù„Øª Ú¯Ø§Ø±Ø¯ ÛŒÙˆÙ†ÛŒØª |
| guard_debug | Ù„Ø§Ú¯ GuardLogger |

### Roadmap (Next Phases)
- Embedding-based similarity fallback (semantic precision Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡)
- Adaptive threshold per field length
- Correction suggestion layer (report vs auto-fix diff)
- CI gate: fail PR Ø§Ú¯Ø± `avg_hallucination_rate > 0` ÛŒØ§ `fidelity_ok=false`
- Structured remediation report endpoint (`/hoosha/guard/report`)

Reject any optimization that only fits the examplesâ€”Ù‡Ù…Ú†Ù†Ø§Ù† Ø§ØµÙ„ Ø¨Ù†ÛŒØ§Ø¯ÛŒ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯.

Endpoint `preview_edit` Ø®Ø±ÙˆØ¬ÛŒ Ù†Ù…ÙˆÙ†Ù‡:
```
{
	"ok": true,
	"commands": ["Ø³ÙˆØ§Ù„ Ø§ÙˆÙ„ Ø±Ø³Ù…ÛŒ Ø´ÙˆØ¯"],
	"preview_schema": { "fields": [...] },
	"deltas": [{"op":"update_label","field_index":0}],
	"notes": ["pipe:preview_edit_start","ai:preview_success(1)"]
}
```

Ù…Ø²Ø§ÛŒØ§: Ø¨Ø¯ÙˆÙ† Ø§Ø¹Ù…Ø§Ù„ ÙÙˆØ±ÛŒØŒ Ø§Ù…Ú©Ø§Ù† Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ Ùˆ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØºÛŒÛŒØ± Ù†Ø§Ø®ÙˆØ§Ø³ØªÙ‡.

### Diff Ù¾ÛŒØ´Ø±ÙØªÙ‡ØŒ Ø¨Ø§Ø²Ú¯Ø´Øª (Undo) Ùˆ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§
Ù‡Ù†Ú¯Ø§Ù… Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ØŒ Ø§Ú¯Ø± Ù…Ø¯Ù„ ÛŒØ§ Ø³ÛŒØ³ØªÙ… Ù…Ø­Ù„ÛŒ `deltas` ØªÙˆÙ„ÛŒØ¯ Ú©Ù†Ø¯ØŒ Ù‡Ø± Ø¢ÛŒØªÙ… Ø¨Ø§ Ø±Ù†Ú¯ Ú©Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯:
- Ø³Ø¨Ø² (add_field)
- Ù‚Ø±Ù…Ø² (remove_field)
- Ø¢Ø¨ÛŒ (update_label / update_type / update_required)

Ø¨Ø§ ØªØ§ÛŒÛŒØ¯ØŒ Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ÛŒ Ø¯Ø± ÛŒÚ© Ù¾Ø´ØªÙ‡ (Stack) Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¯Ú©Ù…Ù‡ Â«Ø¨Ø§Ø²Ú¯Ø´ØªÂ» ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯. Ø¨Ø§ Ù‡Ø± Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ú¯Ø± Ù¾Ø´ØªÙ‡ Ø®Ø§Ù„ÛŒ Ø´ÙˆØ¯ Ø¯Ú©Ù…Ù‡ Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø´Ù…Ø§Ø± Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± Ù†Ø§Ø­ÛŒÙ‡ Ú©ÙˆÚ†Ú© Ø²ÛŒØ± Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Diff Ù…Ø­Ù„ÛŒ Ø¯Ø± Ù†Ø¨ÙˆØ¯ deltas Ù…Ø¯Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ø²ÛŒØ± Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯:
- Ø§ÙØ²ÙˆØ¯Ù† ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯ (add_field)
- Ø­Ø°Ù ÙÛŒÙ„Ø¯ (remove_field)
- ØªØºÛŒÛŒØ± Label (update_label)
- ØªØºÛŒÛŒØ± Ù†ÙˆØ¹ (update_type)
- ØªØºÛŒÛŒØ± required (update_required)

Ù†ÙˆØªâ€ŒÙ‡Ø§ÛŒ ØªÙØ³ÛŒØ±ÛŒ Ù…Ù…Ú©Ù†:
- `ai:interpret_start`
- `ai:interpret_success(N)`
- Ø¯Ø± Ø­Ø§Ù„Øª ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† AI: `ai:interpret_ai_disabled`

Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ ØªÙ‚Ø³ÛŒÙ…â€ŒØ¨Ù†Ø¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡â€ŒÛŒ Ù…Ø­Ù„ÛŒ (Heuristic Splitting) Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
## ØªÙˆØ³Ø¹Ù‡ Ùˆ ØªØ³Øª

Ù…Ø§ØªØ±ÛŒØ³ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Hoosha: `docs/HOOSHA_SCENARIOS.md`

Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§:

```bash
composer install
composer test
```

## Ù†Ú©Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ

- Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ GET Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ ÙØ±Ù…â€ŒÙ‡Ø§ ØªÙ†Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ÛŒ Ú©Ù‡ Ø­Ø¯Ø§Ù‚Ù„ ØªÙˆØ§Ù†Ø§ÛŒÛŒ `edit_posts` Ø¯Ø§Ø±Ù†Ø¯ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª.
- Ù‡ÙˆÚ©â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ nonce Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ù‡Ø³ØªÙ†Ø¯.
- Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ø² Ù…Ø³ÛŒØ± `assets/` Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ø§Ø² Ø·Ø±ÛŒÙ‚ `wp_enqueue_script` Ùˆ `wp_enqueue_style` Ø¯Ø± ØµÙØ­Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.

## Hoosha CLI Simulation (Offline Testing)
Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ ÙØ±Ù…â€ŒØ³Ø§Ø² Ø¨Ø¯ÙˆÙ† ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ HTTP Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø®Ø±ÙˆØ¬ÛŒ Ú©Ø§Ù…Ù„ (schemaØŒ notesØŒ guard):

Ù…Ø«Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ø§Ø² Ù¾ÛŒØ´ ØªØ¹Ø±ÛŒÙâ€ŒØ´Ø¯Ù‡:
```powershell
php tools/simulate_hoosha.php --file=tools/hoosha_scenarios.json --id=duplicate_explosion
```

Ù…Ø«Ø§Ù„ ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø¯ÙˆÙ† Ù…Ø¯Ù„ (ÙÙ‚Ø· baseline + guard):
```powershell
php tools/simulate_hoosha.php --text="Ù†Ø§Ù… Ùˆ Ú©Ø¯ Ù…Ù„ÛŒ Ùˆ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" --no-model --json-only
```

Ø³ÙˆØ¦ÛŒÚ†â€ŒÙ‡Ø§:
- `--file=PATH` + `--id=ID` Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ù†Ø§Ø±ÛŒÙˆ.
- `--text=...` ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… (Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² id).
- `--no-model` ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§ÛŒÙ‡ Ù…Ø¯Ù„ (Ù…ÙÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø®Ù„ÙˆØµ baseline Ùˆ Guard).
- `--guard=0|1` Ø§Ø¬Ø¨Ø§Ø± ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Guard (Ø¯Ø± Ù†Ø¨ÙˆØ¯ ØªÙ†Ø¸ÛŒÙ… â†’ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙØ¹Ø§Ù„).
- `--json-only` Ø®Ø±ÙˆØ¬ÛŒ ÙÙ‚Ø· JSON Ø®Ø§Ù….

Ø®Ø±ÙˆØ¬ÛŒ Ø®Ù„Ø§ØµÙ‡ Ø´Ø§Ù…Ù„:
- field_countØŒ duplicates_estimatedØŒ guard_approved
- guard_issues Ùˆ issues_detail (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯)
- jalali_present Ùˆ yn_contamination Ø¬Ù‡Øª ØªØ´Ø®ÛŒØµ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ

ÙØ§ÛŒÙ„ Ø³Ù†Ø§Ø±ÛŒÙˆ Ù†Ù…ÙˆÙ†Ù‡: `tools/hoosha_scenarios.json` â€“ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ Ø±Ø§ Ø¨Ø§ `{ "id":"...","text":"..." }` Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.

Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ ØªØ³Øª Guard Ø¨Ø¯ÙˆÙ† ØªÙ…Ø§Ø³ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ Ù…Ø¯Ù„ØŒ base_url Ø¬Ø¹Ù„ÛŒ Ùˆ api_key ØªØ³Øª Ø³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù…Ø³ÛŒØ± Ù…Ø¯Ù„ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯Ø› Guard Ù‡Ù…Ú†Ù†Ø§Ù† Ø§Ø¬Ø±Ø§ Ùˆ prune Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
